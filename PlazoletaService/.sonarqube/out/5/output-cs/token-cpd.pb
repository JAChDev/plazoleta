Ü
„C:\Users\jonatan.amado_pragma\Documents\Repositorios\AppPlazoleta\PlazoletaService\Plazoleta.Infrastructure\Database\SQLDbContext.cs
	namespace

 	
PlazoletaService


 
.

 
Infrastructure

 )
.

) *
Database

* 2
{ 
public 

class 
SQLDbContext 
: 
	DbContext '
{ 
public 
SQLDbContext 
( 
DbContextOptions ,
<, -
SQLDbContext- 9
>9 :
options; B
)B C
:D E
baseF J
(J K
optionsK R
)R S
{ 	
} 	
	protected 
override 
void 
OnModelCreating  /
(/ 0
ModelBuilder0 <
modelBuilder= I
)I J
{ 	
base 
. 
OnModelCreating  
(  !
modelBuilder! -
)- .
;. /
modelBuilder 
. 
Entity 
<  
OrderProductDTO  /
>/ 0
(0 1
)1 2
.2 3
HasNoKey3 ;
(; <
)< =
;= >
} 	
public 
DbSet 
< 
RestaurantDTO "
>" #
restaurantes$ 0
{1 2
get3 6
;6 7
set8 ;
;; <
}= >
public 
DbSet 
< 

ProductDTO 
>  
platos! '
{( )
get* -
;- .
set/ 2
;2 3
}4 5
public 
DbSet 
< 
OrderDTO 
> 
pedidos &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
public 
DbSet 
< 
OrderProductDTO $
>$ %
pedidos_Platos& 4
{5 6
get7 :
;: ;
set< ?
;? @
}A B
} 
} º
ƒC:\Users\jonatan.amado_pragma\Documents\Repositorios\AppPlazoleta\PlazoletaService\Plazoleta.Infrastructure\InfrastructureModule.cs
	namespace

 	
PlazoletaService


 
.

 
Infrastructure

 )
{ 
public 

class  
InfrastructureModule %
:% &
Module& ,
{ 
	protected 
override 
void 
Load  $
($ %
ContainerBuilder% 5
builder6 =
)= >
{ 	
builder 
. 
RegisterType  
<  !
MySQLRepository! 0
>0 1
(1 2
)2 3
.3 4
As4 6
<6 7
IMySQLRepository7 G
>G H
(H I
)I J
.J K$
InstancePerLifetimeScopeK c
(c d
)d e
;e f
} 	
} 
} £•
‹C:\Users\jonatan.amado_pragma\Documents\Repositorios\AppPlazoleta\PlazoletaService\Plazoleta.Infrastructure\Repositories\MySQLRepository.cs
	namespace 	
PlazoletaService
 
. 
Infrastructure )
.) *
Repositories* 6
{ 
public 

class 
MySQLRepository  
:! "
IMySQLRepository# 3
{ 
private 
readonly 
SQLDbContext %

_dbContext& 0
;0 1
public 
MySQLRepository 
( 
SQLDbContext +
	dbContext, 5
)5 6
{ 	

_dbContext 
= 
	dbContext "
;" #
} 	
public 

DbResponse 
CreateProduct '
(' (

ProductDTO( 2

productDTO3 =
)= >
{ 	
try 
{ 

_dbContext 
. 
platos !
.! "
Add" %
(% &

productDTO& 0
)0 1
;1 2

_dbContext 
. 
SaveChanges &
(& '
)' (
;( )
return 
new 

DbResponse %
{& '
Success( /
=0 1
true2 6
,6 7
Message8 ?
=@ A
$strB S
}T U
;U V
} 
catch 
( 
	Exception 
ex 
)  
{ 
return   
new   

DbResponse   %
{  & '
Success  ( /
=  0 1
false  2 7
,  7 8
Message  9 @
=  A B
ex  C E
.  E F
Message  F M
}  N O
;  O P
}!! 
}"" 	
public$$ 

DbResponse$$ 
CreateRestaurant$$ *
($$* +
RestaurantDTO$$+ 8
restaurantDTO$$9 F
)$$F G
{%% 	
try&& 
{'' 

_dbContext(( 
.(( 
restaurantes(( '
.((' (
Add((( +
(((+ ,
restaurantDTO((, 9
)((9 :
;((: ;

_dbContext)) 
.)) 
SaveChanges)) &
())& '
)))' (
;))( )
return** 
new** 

DbResponse** %
{**& '
Success**( /
=**0 1
true**2 6
,**6 7
Message**8 ?
=**@ A
$str**B Y
}**Z [
;**[ \
}++ 
catch,, 
(,, 
	Exception,, 
ex,, 
),,  
{-- 
return.. 
new.. 

DbResponse.. %
{..& '
Success..( /
=..0 1
false..2 7
,..7 8
Message..9 @
=..A B
ex..C E
...E F
Message..F M
}..M N
;..N O
}// 
}00 	
public22 
RestaurantDTO22 "
GetRestaurantByOwnerId22 3
(223 4
int224 7
id228 :
)22: ;
{33 	
try44 
{55 
var66 

restaurant66 
=66  

_dbContext66! +
.66+ ,
restaurantes66, 8
.668 9
Where669 >
(66> ?
x66? @
=>66A C
x66D E
.66E F
id_propietario66F T
==66U W
id66X Z
)66Z [
.66[ \
ToList66\ b
(66b c
)66c d
;66d e
if77 
(77 

restaurant77 
.77 
FirstOrDefault77 -
(77- .
)77. /
!=770 2
null773 7
)777 8
{88 
return99 

restaurant99 %
.99% &
FirstOrDefault99& 4
(994 5
)995 6
;996 7
}:: 
else;; 
{;; 
return<< 
null<< 
;<<  
}== 
}>> 
catch?? 
{@@ 
returnAA 
nullAA 
;AA 
}BB 
}CC 	
publicEE 

ProductDTOEE 
GetProductByIdEE (
(EE( )
intEE) ,
idEE- /
)EE/ 0
{FF 	
tryGG 
{HH 
varII 
platoII 
=II 

_dbContextII &
.II& '
platosII' -
.II- .
FindII. 2
(II2 3
idII3 5
)II5 6
;II6 7
ifJJ 
(JJ 
platoJJ 
!=JJ 
nullJJ !
)JJ! "
{JJ# $
returnJJ% +
platoJJ, 1
;JJ1 2
}JJ3 4
elseKK 
{KK 
returnKK 
nullKK "
;KK" #
}KK$ %
}LL 
catchMM 
{MM 
returnMM 
nullMM 
;MM  
}MM! "
}NN 	
publicPP 

DbResponsePP 
UpdateProductPP '
(PP' (
ModifyProductDTOPP( 8

productDTOPP9 C
)PPC D
{QQ 	
tryRR 
{SS 
varTT 
platoTT 
=TT 

_dbContextTT &
.TT& '
platosTT' -
.TT- .
FindTT. 2
(TT2 3

productDTOTT3 =
.TT= >
IdTT> @
)TT@ A
;TTA B
ifUU 
(UU 
platoUU 
!=UU 
nullUU !
)UU! "
{VV 
platoWW 
.WW 
NombreWW  
=WW! "

productDTOWW# -
.WW- .
NombreWW. 4
;WW4 5
platoXX 
.XX 
DescripcionXX %
=XX& '

productDTOXX( 2
.XX2 3
DescripcionXX3 >
;XX> ?

_dbContextYY 
.YY 
SaveChangesYY *
(YY* +
)YY+ ,
;YY, -
returnZZ 
newZZ 

DbResponseZZ )
{ZZ* +
SuccessZZ, 3
=ZZ4 5
trueZZ6 :
,ZZ: ;
MessageZZ< C
=ZZD E
$strZZF X
}ZZY Z
;ZZZ [
}[[ 
else\\ 
{]] 
return^^ 
new^^ 

DbResponse^^ )
{^^* +
Success^^, 3
=^^4 5
false^^6 ;
,^^; <
Message^^= D
=^^E F
$str^^G h
}^^i j
;^^j k
}__ 
}`` 
catchaa 
(aa 
	Exceptionaa 
exaa 
)aa  
{bb 
returncc 
newcc 

DbResponsecc %
{cc& '
Successcc( /
=cc0 1
falsecc2 7
,cc7 8
Messagecc9 @
=ccA B
exccC E
.ccE F
MessageccF M
}ccN O
;ccO P
}dd 
}ee 	
publicgg 

DbResponsegg 
ActivateProductgg )
(gg) *
intgg* -
	productIdgg. 7
)gg7 8
{hh 	
tryii 
{jj 
varkk 
platokk 
=kk 

_dbContextkk &
.kk& '
platoskk' -
.kk- .
Findkk. 2
(kk2 3
	productIdkk3 <
)kk< =
;kk= >
ifll 
(ll 
platoll 
!=ll 
nullll !
)ll! "
{mm 
platonn 
.nn 
Activonn  
=nn! "
!nn# $
platonn$ )
.nn) *
Activonn* 0
;nn0 1

_dbContextoo 
.oo 
SaveChangesoo *
(oo* +
)oo+ ,
;oo, -
returnpp 
newpp 

DbResponsepp )
{pp* +
Successpp, 3
=pp4 5
truepp6 :
,pp: ;
Messagepp< C
=ppD E
platoppF K
.ppK L
ActivoppL R
==ppS U
trueppV Z
?pp[ \
$strpp] m
:ppn o
$str	ppp ƒ
}
pp„ …
;
pp… †
}qq 
elserr 
{ss 
returntt 
newtt 

DbResponsett )
{tt* +
Successtt, 3
=tt4 5
falsett6 ;
,tt; <
Messagett= D
=ttE F
$strttG h
}tti j
;ttj k
}uu 
}vv 
catchww 
(ww 
	Exceptionww 
exww 
)ww  
{xx 
returnyy 
newyy 

DbResponseyy %
{yy& '
Successyy( /
=yy0 1
falseyy2 7
,yy7 8
Messageyy9 @
=yyA B
exyyC E
.yyE F
MessageyyF M
}yyN O
;yyO P
}zz 
}{{ 	
public}} 
List}} 
<}} 
RestaurantDTO}} !
>}}! "
GetRestaurants}}# 1
(}}1 2
int}}2 5

pageNumber}}6 @
,}}@ A
int}}B E
pageSize}}F N
)}}N O
{~~ 	
try 
{
€€ 
var
 
restaurants
 
=
  !

_dbContext
" ,
.
, -
restaurantes
- 9
.
9 :
AsQueryable
: E
(
E F
)
F G
;
G H
int
‚‚ 
total
‚‚ 
=
‚‚ 
restaurants
‚‚ '
.
‚‚' (
Count
‚‚( -
(
‚‚- .
)
‚‚. /
;
‚‚/ 0
int
ƒƒ 
pages
ƒƒ 
=
ƒƒ 
(
ƒƒ 
int
ƒƒ  
)
ƒƒ  !
Math
ƒƒ! %
.
ƒƒ% &
Ceiling
ƒƒ& -
(
ƒƒ- .
(
ƒƒ. /
double
ƒƒ/ 5
)
ƒƒ5 6
total
ƒƒ6 ;
/
ƒƒ< =
pageSize
ƒƒ> F
)
ƒƒF G
;
ƒƒG H

pageNumber
„„ 
=
„„ 
Math
„„ !
.
„„! "
Max
„„" %
(
„„% &
$num
„„& '
,
„„' (
Math
„„) -
.
„„- .
Min
„„. 1
(
„„1 2

pageNumber
„„2 <
,
„„< =
pageSize
„„> F
)
„„F G
)
„„G H
;
„„H I
int
…… 
skippep
…… 
=
…… 
(
…… 

pageNumber
…… )
-
……* +
$num
……, -
)
……- .
*
……/ 0
pageSize
……1 9
;
……9 :
restaurants
†† 
=
†† 
restaurants
†† )
.
††) *
OrderBy
††* 1
(
††1 2
r
††2 3
=>
††4 6
r
††7 8
.
††8 9
Nombre
††9 ?
)
††? @
;
††@ A
restaurants
‡‡ 
=
‡‡ 
restaurants
‡‡ )
.
‡‡) *
Skip
‡‡* .
(
‡‡. /
skippep
‡‡/ 6
)
‡‡6 7
.
‡‡7 8
Take
‡‡8 <
(
‡‡< =
pageSize
‡‡= E
)
‡‡E F
;
‡‡F G
return
ˆˆ 
restaurants
ˆˆ "
.
ˆˆ" #
ToList
ˆˆ# )
(
ˆˆ) *
)
ˆˆ* +
;
ˆˆ+ ,
}
‰‰ 
catch
ŠŠ 
{
‹‹ 
return
ŒŒ 
null
ŒŒ 
;
ŒŒ 
}
 
}
 	
public
 
List
 
<
 

ProductDTO
 
>
 %
GetProductsByRestaurant
  7
(
7 8
int
8 ;
restaurantId
< H
,
H I
int
J M

pageNumber
N X
,
X Y
int
Z ]
pageSize
^ f
)
f g
{
‘‘ 	
try
’’ 
{
““ 
var
”” 
products
”” 
=
”” 

_dbContext
”” )
.
””) *
platos
””* 0
.
””0 1
Where
””1 6
(
””6 7
p
””7 8
=>
””9 ;
p
””< =
.
””= >
id_restaurante
””> L
==
””M O
restaurantId
””P \
)
””\ ]
.
•• 
GroupBy
•• 
(
•• 
p
•• 
=>
•• !
p
••" #
.
••# $
id_categoria
••$ 0
)
••0 1
.
–– 
Select
–– 
(
–– 
g
–– 
=>
––  
new
––! $
{
––% &
	Categoria
––& /
=
––0 1
g
––2 3
.
––3 4
Key
––4 7
,
––7 8
platos
––9 ?
=
––@ A
g
––B C
.
––C D
ToList
––D J
(
––J K
)
––K L
}
––M N
)
––N O
;
––O P
int
—— 
total
—— 
=
—— 
products
—— $
.
——$ %
Count
——% *
(
——* +
)
——+ ,
;
——, -
var
šš 
	resultado
šš 
=
šš 
products
šš  (
.
›› 
AsEnumerable
›› !
(
››! "
)
››" #
.
œœ 
Skip
œœ 
(
œœ 
(
œœ 

pageNumber
œœ %
-
œœ& '
$num
œœ( )
)
œœ) *
*
œœ+ ,
pageSize
œœ- 5
)
œœ5 6
.
 
Take
 
(
 
pageSize
 "
)
" #
.
 

SelectMany
 
(
  
g
  !
=>
" $
g
% &
.
& '
platos
' -
)
- .
.
ŸŸ 
ToList
ŸŸ 
(
ŸŸ 
)
ŸŸ 
;
ŸŸ 
return
   
	resultado
    
;
    !
}
¢¢ 
catch
££ 
{
¤¤ 
return
¥¥ 
null
¥¥ 
;
¥¥ 
}
¦¦ 
}
§§ 	
public
©© 

DbResponse
©© 
CreateOrder
©© %
(
©©% &
OrderDTO
©©& .
order
©©/ 4
)
©©4 5
{
ªª 	
try
«« 
{
¬¬ 

_dbContext
­­ 
.
­­ 
pedidos
­­ "
.
­­" #
Add
­­# &
(
­­& '
order
­­' ,
)
­­, -
;
­­- .

_dbContext
®® 
.
®® 
SaveChanges
®® &
(
®®& '
)
®®' (
;
®®( )
return
¯¯ 
new
¯¯ 

DbResponse
¯¯ %
{
¯¯& '
Success
¯¯( /
=
¯¯0 1
true
¯¯2 6
,
¯¯6 7
Message
¯¯8 ?
=
¯¯@ A
$str
¯¯B Q
}
¯¯R S
;
¯¯S T
}
±± 
catch
²² 
(
²² 
	Exception
²² 
ex
²² 
)
²²  
{
³³ 
return
´´ 
new
´´ 

DbResponse
´´ %
{
´´& '
Success
´´( /
=
´´0 1
false
´´2 7
,
´´7 8
Message
´´9 @
=
´´A B
ex
´´C E
.
´´E F
Message
´´F M
}
´´N O
;
´´O P
}
¶¶ 
}
·· 	
public
¹¹ 

DbResponse
¹¹ 
AddOrderProduct
¹¹ )
(
¹¹) *
OrderProductDTO
¹¹* 9
orderProduct
¹¹: F
)
¹¹F G
{
ºº 	
try
»» 
{
¼¼ 
var
½½ 
order
½½ 
=
½½ 

_dbContext
½½ &
.
½½& '
pedidos
½½' .
.
½½. /
Find
½½/ 3
(
½½3 4
orderProduct
½½4 @
.
½½@ A
	id_Pedido
½½A J
)
½½J K
;
½½K L
if
¾¾ 
(
¾¾ 
order
¾¾ 
!=
¾¾ 
null
¾¾ !
)
¾¾! "
{
¿¿ 

_dbContext
ÀÀ 
.
ÀÀ 
pedidos_Platos
ÀÀ -
.
ÀÀ- .
Add
ÀÀ. 1
(
ÀÀ1 2
orderProduct
ÀÀ2 >
)
ÀÀ> ?
;
ÀÀ? @

_dbContext
ÁÁ 
.
ÁÁ 
SaveChanges
ÁÁ *
(
ÁÁ* +
)
ÁÁ+ ,
;
ÁÁ, -
return
ÂÂ 
new
ÂÂ 

DbResponse
ÂÂ )
{
ÂÂ* +
Success
ÂÂ, 3
=
ÂÂ4 5
true
ÂÂ6 :
,
ÂÂ: ;
Message
ÂÂ< C
=
ÂÂD E
$str
ÂÂF b
}
ÂÂc d
;
ÂÂd e
}
ÃÃ 
else
ÄÄ 
{
ÅÅ 
return
ÆÆ 
new
ÆÆ 

DbResponse
ÆÆ )
{
ÆÆ* +
Success
ÆÆ, 3
=
ÆÆ4 5
false
ÆÆ6 ;
,
ÆÆ; <
Message
ÆÆ= D
=
ÆÆE F
$str
ÆÆG f
}
ÆÆg h
;
ÆÆh i
}
ÇÇ 
}
ÈÈ 
catch
ÉÉ 
(
ÉÉ 
	Exception
ÉÉ 
ex
ÉÉ 
)
ÉÉ  
{
ÊÊ 
return
ËË 
new
ËË 

DbResponse
ËË %
{
ËË& '
Success
ËË( /
=
ËË0 1
false
ËË2 7
,
ËË7 8
Message
ËË9 @
=
ËËA B
ex
ËËC E
.
ËËE F
Message
ËËF M
}
ËËN O
;
ËËO P
}
ÍÍ 
}
ÎÎ 	
public
ĞĞ 
List
ĞĞ 
<
ĞĞ 
OrderDTO
ĞĞ 
>
ĞĞ !
GetOrdersWithFilter
ĞĞ 1
(
ĞĞ1 2
int
ĞĞ2 5
id
ĞĞ6 8
,
ĞĞ8 9
string
ĞĞ: @
filter
ĞĞA G
,
ĞĞG H
int
ĞĞI L

pageNumber
ĞĞM W
,
ĞĞW X
int
ĞĞY \
pageSize
ĞĞ] e
)
ĞĞe f
{
ÑÑ 	
try
ÒÒ 
{
ÓÓ 
var
ÔÔ 
Orders
ÔÔ 
=
ÔÔ 

_dbContext
ÔÔ '
.
ÔÔ' (
pedidos
ÔÔ( /
.
ÔÔ/ 0
Where
ÔÔ0 5
(
ÔÔ5 6
p
ÔÔ6 7
=>
ÔÔ8 :
p
ÔÔ; <
.
ÔÔ< =
id_Restaurante
ÔÔ= K
==
ÔÔL N
id
ÔÔO Q
&&
ÔÔR T
p
ÔÔU V
.
ÔÔV W
Estado
ÔÔW ]
==
ÔÔ] _
filter
ÔÔ_ e
)
ÔÔe f
.
ÔÔf g
ToList
ÔÔg m
(
ÔÔm n
)
ÔÔn o
;
ÔÔo p
int
ÕÕ 
total
ÕÕ 
=
ÕÕ 
Orders
ÕÕ "
.
ÕÕ" #
Count
ÕÕ# (
(
ÕÕ( )
)
ÕÕ) *
;
ÕÕ* +
int
ÖÖ 
pages
ÖÖ 
=
ÖÖ 
(
ÖÖ 
int
ÖÖ  
)
ÖÖ  !
Math
ÖÖ! %
.
ÖÖ% &
Ceiling
ÖÖ& -
(
ÖÖ- .
(
ÖÖ. /
double
ÖÖ/ 5
)
ÖÖ5 6
total
ÖÖ6 ;
/
ÖÖ< =
pageSize
ÖÖ> F
)
ÖÖF G
;
ÖÖG H
var
ØØ 
	resultado
ØØ 
=
ØØ 
Orders
ØØ  &
.
ÙÙ 
AsEnumerable
ÙÙ !
(
ÙÙ! "
)
ÙÙ" #
.
ÚÚ 
Skip
ÚÚ 
(
ÚÚ 
(
ÚÚ 

pageNumber
ÚÚ %
-
ÚÚ& '
$num
ÚÚ( )
)
ÚÚ) *
*
ÚÚ+ ,
pageSize
ÚÚ- 5
)
ÚÚ5 6
.
ÛÛ 
Take
ÛÛ 
(
ÛÛ 
pageSize
ÛÛ "
)
ÛÛ" #
.
ÜÜ 
ToList
ÜÜ 
(
ÜÜ 
)
ÜÜ 
;
ÜÜ 
return
İİ 
	resultado
İİ  
;
İİ  !
}
ŞŞ 
catch
ßß 
(
ßß 
	Exception
ßß 
ex
ßß 
)
ßß  
{
àà 
return
áá 
null
áá 
;
áá 
}
ââ 
}
ãã 	
}
ää 
}åå 