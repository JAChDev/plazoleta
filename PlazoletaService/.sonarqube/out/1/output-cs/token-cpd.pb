È
ÑC:\Users\jonatan.amado_pragma\Documents\Repositorios\AppPlazoleta\PlazoletaService\Plazoleta.Infrastructure\Database\SQLDbContext.cs
	namespace

 	
PlazoletaService


 
.

 
Infrastructure

 )
.

) *
Database

* 2
{ 
public 

class 
SQLDbContext 
: 
	DbContext '
{ 
private 
readonly 
IConfiguration '
_configuration( 6
;6 7
public 
SQLDbContext 
( 
DbContextOptions ,
<, -
SQLDbContext- 9
>9 :
options; B
,B C
IConfigurationD R
configurationS `
)` a
:b c
based h
(h i
optionsi p
)p q
{ 	
_configuration 
= 
configuration *
;* +
} 	
	protected 
override 
void 
OnModelCreating  /
(/ 0
ModelBuilder0 <
modelBuilder= I
)I J
{ 	
base 
. 
OnModelCreating  
(  !
modelBuilder! -
)- .
;. /
modelBuilder 
. 
Entity 
<  
OrderProductDTO  /
>/ 0
(0 1
)1 2
.2 3
HasNoKey3 ;
(; <
)< =
;= >
} 	
public 
DbSet 
< 
RestaurantDTO "
>" #
restaurantes$ 0
{1 2
get3 6
;6 7
set8 ;
;; <
}= >
public 
DbSet 
< 

ProductDTO 
>  
platos! '
{( )
get* -
;- .
set/ 2
;2 3
}4 5
public 
DbSet 
< 
OrderDTO 
> 
pedidos &
{' (
get) ,
;, -
set. 1
;1 2
}3 4
public 
DbSet 
< 
OrderProductDTO $
>$ %
pedidos_Platos& 4
{5 6
get7 :
;: ;
set< ?
;? @
}A B
} 
}   ∫
ÉC:\Users\jonatan.amado_pragma\Documents\Repositorios\AppPlazoleta\PlazoletaService\Plazoleta.Infrastructure\InfrastructureModule.cs
	namespace

 	
PlazoletaService


 
.

 
Infrastructure

 )
{ 
public 

class  
InfrastructureModule %
:% &
Module& ,
{ 
	protected 
override 
void 
Load  $
($ %
ContainerBuilder% 5
builder6 =
)= >
{ 	
builder 
. 
RegisterType  
<  !
MySQLRepository! 0
>0 1
(1 2
)2 3
.3 4
As4 6
<6 7
IMySQLRepository7 G
>G H
(H I
)I J
.J K$
InstancePerLifetimeScopeK c
(c d
)d e
;e f
} 	
} 
} Äô
ãC:\Users\jonatan.amado_pragma\Documents\Repositorios\AppPlazoleta\PlazoletaService\Plazoleta.Infrastructure\Repositories\MySQLRepository.cs
	namespace 	
PlazoletaService
 
. 
Infrastructure )
.) *
Repositories* 6
{ 
public 

class 
MySQLRepository  
:! "
IMySQLRepository# 3
{ 
private 
readonly 
SQLDbContext %

_dbContext& 0
;0 1
public 
MySQLRepository 
( 
SQLDbContext +
	dbContext, 5
)5 6
{ 	

_dbContext 
= 
	dbContext "
;" #
} 	
public 

DbResponse 
CreateProduct '
(' (

ProductDTO( 2

productDTO3 =
)= >
{ 	
try 
{ 

_dbContext 
. 
platos !
.! "
Add" %
(% &

productDTO& 0
)0 1
;1 2

_dbContext 
. 
SaveChanges &
(& '
)' (
;( )
return 
new 

DbResponse %
{& '
Success( /
=0 1
true2 6
,6 7
Message8 ?
=@ A
$strB S
}T U
;U V
} 
catch 
( 
	Exception 
ex 
)  
{ 
return   
new   

DbResponse   %
{  & '
Success  ( /
=  0 1
false  2 7
,  7 8
Message  9 @
=  A B
ex  C E
.  E F
Message  F M
}  N O
;  O P
}!! 
}"" 	
public$$ 

DbResponse$$ 
CreateRestaurant$$ *
($$* +
RestaurantDTO$$+ 8
restaurantDTO$$9 F
)$$F G
{%% 	
try&& 
{'' 

_dbContext(( 
.(( 
restaurantes(( '
.((' (
Add((( +
(((+ ,
restaurantDTO((, 9
)((9 :
;((: ;

_dbContext)) 
.)) 
SaveChanges)) &
())& '
)))' (
;))( )
return** 
new** 

DbResponse** %
{**& '
Success**( /
=**0 1
true**2 6
,**6 7
Message**8 ?
=**@ A
$str**B Y
}**Z [
;**[ \
}++ 
catch,, 
(,, 
	Exception,, 
ex,, 
),,  
{-- 
return.. 
new.. 

DbResponse.. %
{..& '
Success..( /
=..0 1
false..2 7
,..7 8
Message..9 @
=..A B
ex..C E
...E F
Message..F M
}..M N
;..N O
}// 
}00 	
public22 
RestaurantDTO22 "
GetRestaurantByOwnerId22 3
(223 4
int224 7
id228 :
)22: ;
{33 	
try44 
{55 
var66 

restaurant66 
=66  

_dbContext66! +
.66+ ,
restaurantes66, 8
.668 9
Where669 >
(66> ?
x66? @
=>66A C
x66D E
.66E F
id_propietario66F T
==66U W
id66X Z
)66Z [
.66[ \
ToList66\ b
(66b c
)66c d
;66d e
if77 
(77 

restaurant77 
.77 
FirstOrDefault77 -
(77- .
)77. /
!=770 2
null773 7
)777 8
{88 
return99 

restaurant99 %
.99% &
FirstOrDefault99& 4
(994 5
)995 6
;996 7
}:: 
else;; 
{;; 
return<< 
null<< 
;<<  
}== 
}>> 
catch?? 
(?? 
	Exception?? 
ex?? 
)??  
{@@ 
returnAA 
nullAA 
;AA 
}BB 
}CC 	
publicEE 

ProductDTOEE 
GetProductByIdEE (
(EE( )
intEE) ,
idEE- /
)EE/ 0
{FF 	
tryGG 
{HH 
varII 
platoII 
=II 

_dbContextII &
.II& '
platosII' -
.II- .
FindII. 2
(II2 3
idII3 5
)II5 6
;II6 7
ifJJ 
(JJ 
platoJJ 
!=JJ 
nullJJ !
)JJ! "
{JJ# $
returnJJ% +
platoJJ, 1
;JJ1 2
}JJ3 4
elseKK 
{KK 
returnKK 
nullKK "
;KK" #
}KK$ %
}LL 
catchMM 
(MM 
	ExceptionMM 
exMM 
)MM  
{MM! "
returnMM# )
nullMM* .
;MM. /
}MM0 1
}NN 	
publicPP 

DbResponsePP 
UpdateProductPP '
(PP' (
ModifyProductDTOPP( 8

productDTOPP9 C
)PPC D
{QQ 	
tryRR 
{SS 
varTT 
platoTT 
=TT 

_dbContextTT &
.TT& '
platosTT' -
.TT- .
FindTT. 2
(TT2 3

productDTOTT3 =
.TT= >
IdTT> @
)TT@ A
;TTA B
ifUU 
(UU 
platoUU 
!=UU 
nullUU !
)UU! "
{VV 
platoWW 
.WW 
NombreWW  
=WW! "

productDTOWW# -
.WW- .
NombreWW. 4
;WW4 5
platoXX 
.XX 
DescripcionXX %
=XX& '

productDTOXX( 2
.XX2 3
DescripcionXX3 >
;XX> ?

_dbContextYY 
.YY 
SaveChangesYY *
(YY* +
)YY+ ,
;YY, -
returnZZ 
newZZ 

DbResponseZZ )
{ZZ* +
SuccessZZ, 3
=ZZ4 5
trueZZ6 :
,ZZ: ;
MessageZZ< C
=ZZD E
$strZZF X
}ZZY Z
;ZZZ [
}[[ 
else\\ 
{]] 
return^^ 
new^^ 

DbResponse^^ )
{^^* +
Success^^, 3
=^^4 5
false^^6 ;
,^^; <
Message^^= D
=^^E F
$str^^G h
}^^i j
;^^j k
}__ 
}`` 
catchaa 
(aa 
	Exceptionaa 
exaa 
)aa  
{bb 
returncc 
newcc 

DbResponsecc %
{cc& '
Successcc( /
=cc0 1
falsecc2 7
,cc7 8
Messagecc9 @
=ccA B
exccC E
.ccE F
MessageccF M
}ccN O
;ccO P
}dd 
}ee 	
publicgg 

DbResponsegg 
ActivateProductgg )
(gg) *
intgg* -
	productIdgg. 7
)gg7 8
{hh 	
tryii 
{jj 
varkk 
platokk 
=kk 

_dbContextkk &
.kk& '
platoskk' -
.kk- .
Findkk. 2
(kk2 3
	productIdkk3 <
)kk< =
;kk= >
ifll 
(ll 
platoll 
!=ll 
nullll !
)ll! "
{mm 
platonn 
.nn 
Activonn  
=nn! "
!nn# $
platonn$ )
.nn) *
Activonn* 0
;nn0 1

_dbContextoo 
.oo 
SaveChangesoo *
(oo* +
)oo+ ,
;oo, -
returnpp 
newpp 

DbResponsepp )
{pp* +
Successpp, 3
=pp4 5
truepp6 :
,pp: ;
Messagepp< C
=ppD E
platoppF K
.ppK L
ActivoppL R
==ppS U
trueppV Z
?pp[ \
$strpp] m
:ppn o
$str	ppp É
}
ppÑ Ö
;
ppÖ Ü
}qq 
elserr 
{ss 
returntt 
newtt 

DbResponsett )
{tt* +
Successtt, 3
=tt4 5
falsett6 ;
,tt; <
Messagett= D
=ttE F
$strttG h
}tti j
;ttj k
}uu 
}vv 
catchww 
(ww 
	Exceptionww 
exww 
)ww  
{xx 
returnyy 
newyy 

DbResponseyy %
{yy& '
Successyy( /
=yy0 1
falseyy2 7
,yy7 8
Messageyy9 @
=yyA B
exyyC E
.yyE F
MessageyyF M
}yyN O
;yyO P
}zz 
}{{ 	
public}} 
List}} 
<}} 
RestaurantDTO}} !
>}}! "
GetRestaurants}}# 1
(}}1 2
int}}2 5

pageNumber}}6 @
,}}@ A
int}}B E
pageSize}}F N
)}}N O
{~~ 	
try 
{
ÄÄ 
var
ÅÅ 
restaurants
ÅÅ 
=
ÅÅ  !

_dbContext
ÅÅ" ,
.
ÅÅ, -
restaurantes
ÅÅ- 9
.
ÅÅ9 :
AsQueryable
ÅÅ: E
(
ÅÅE F
)
ÅÅF G
;
ÅÅG H
int
ÇÇ 
total
ÇÇ 
=
ÇÇ 
restaurants
ÇÇ '
.
ÇÇ' (
Count
ÇÇ( -
(
ÇÇ- .
)
ÇÇ. /
;
ÇÇ/ 0
int
ÉÉ 
pages
ÉÉ 
=
ÉÉ 
(
ÉÉ 
int
ÉÉ  
)
ÉÉ  !
Math
ÉÉ! %
.
ÉÉ% &
Ceiling
ÉÉ& -
(
ÉÉ- .
(
ÉÉ. /
double
ÉÉ/ 5
)
ÉÉ5 6
total
ÉÉ6 ;
/
ÉÉ< =
pageSize
ÉÉ> F
)
ÉÉF G
;
ÉÉG H

pageNumber
ÑÑ 
=
ÑÑ 
Math
ÑÑ !
.
ÑÑ! "
Max
ÑÑ" %
(
ÑÑ% &
$num
ÑÑ& '
,
ÑÑ' (
Math
ÑÑ) -
.
ÑÑ- .
Min
ÑÑ. 1
(
ÑÑ1 2

pageNumber
ÑÑ2 <
,
ÑÑ< =
pageSize
ÑÑ> F
)
ÑÑF G
)
ÑÑG H
;
ÑÑH I
int
ÖÖ 
skippep
ÖÖ 
=
ÖÖ 
(
ÖÖ 

pageNumber
ÖÖ )
-
ÖÖ* +
$num
ÖÖ, -
)
ÖÖ- .
*
ÖÖ/ 0
pageSize
ÖÖ1 9
;
ÖÖ9 :
restaurants
ÜÜ 
=
ÜÜ 
restaurants
ÜÜ )
.
ÜÜ) *
OrderBy
ÜÜ* 1
(
ÜÜ1 2
r
ÜÜ2 3
=>
ÜÜ4 6
r
ÜÜ7 8
.
ÜÜ8 9
Nombre
ÜÜ9 ?
)
ÜÜ? @
;
ÜÜ@ A
restaurants
áá 
=
áá 
restaurants
áá )
.
áá) *
Skip
áá* .
(
áá. /
skippep
áá/ 6
)
áá6 7
.
áá7 8
Take
áá8 <
(
áá< =
pageSize
áá= E
)
ááE F
;
ááF G
return
àà 
restaurants
àà "
.
àà" #
ToList
àà# )
(
àà) *
)
àà* +
;
àà+ ,
}
ââ 
catch
ää 
{
ãã 
return
åå 
null
åå 
;
åå 
}
çç 
}
éé 	
public
êê 
List
êê 
<
êê 

ProductDTO
êê 
>
êê %
GetProductsByRestaurant
êê  7
(
êê7 8
int
êê8 ;
restaurantId
êê< H
,
êêH I
int
êêJ M

pageNumber
êêN X
,
êêX Y
int
êêZ ]
pageSize
êê^ f
)
êêf g
{
ëë 	
try
íí 
{
ìì 
var
îî 
products
îî 
=
îî 

_dbContext
îî )
.
îî) *
platos
îî* 0
.
îî0 1
Where
îî1 6
(
îî6 7
p
îî7 8
=>
îî9 ;
p
îî< =
.
îî= >
id_restaurante
îî> L
==
îîM O
restaurantId
îîP \
)
îî\ ]
.
ïï 
GroupBy
ïï 
(
ïï 
p
ïï 
=>
ïï !
p
ïï" #
.
ïï# $
id_categoria
ïï$ 0
)
ïï0 1
.
ññ 
Select
ññ 
(
ññ 
g
ññ 
=>
ññ  
new
ññ! $
{
ññ% &
	Categoria
ññ& /
=
ññ0 1
g
ññ2 3
.
ññ3 4
Key
ññ4 7
,
ññ7 8
platos
ññ9 ?
=
ññ@ A
g
ññB C
.
ññC D
ToList
ññD J
(
ññJ K
)
ññK L
}
ññM N
)
ññN O
;
ññO P
int
óó 
total
óó 
=
óó 
products
óó $
.
óó$ %
Count
óó% *
(
óó* +
)
óó+ ,
;
óó, -
int
òò 
pages
òò 
=
òò 
(
òò 
int
òò  
)
òò  !
Math
òò! %
.
òò% &
Ceiling
òò& -
(
òò- .
(
òò. /
double
òò/ 5
)
òò5 6
total
òò6 ;
/
òò< =
pageSize
òò> F
)
òòF G
;
òòG H
var
öö 
	resultado
öö 
=
öö 
products
öö  (
.
õõ 
AsEnumerable
õõ !
(
õõ! "
)
õõ" #
.
úú 
Skip
úú 
(
úú 
(
úú 

pageNumber
úú %
-
úú& '
$num
úú( )
)
úú) *
*
úú+ ,
pageSize
úú- 5
)
úú5 6
.
ùù 
Take
ùù 
(
ùù 
pageSize
ùù "
)
ùù" #
.
ûû 

SelectMany
ûû 
(
ûû  
g
ûû  !
=>
ûû" $
g
ûû% &
.
ûû& '
platos
ûû' -
)
ûû- .
.
üü 
ToList
üü 
(
üü 
)
üü 
;
üü 
return
†† 
	resultado
††  
;
††  !
}
¢¢ 
catch
££ 
{
§§ 
return
•• 
null
•• 
;
•• 
}
¶¶ 
}
ßß 	
public
©© 

DbResponse
©© 
CreateOrder
©© %
(
©©% &
OrderDTO
©©& .
order
©©/ 4
)
©©4 5
{
™™ 	
try
´´ 
{
¨¨ 

_dbContext
≠≠ 
.
≠≠ 
pedidos
≠≠ "
.
≠≠" #
Add
≠≠# &
(
≠≠& '
order
≠≠' ,
)
≠≠, -
;
≠≠- .

_dbContext
ÆÆ 
.
ÆÆ 
SaveChanges
ÆÆ &
(
ÆÆ& '
)
ÆÆ' (
;
ÆÆ( )
return
ØØ 
new
ØØ 

DbResponse
ØØ %
{
ØØ& '
Success
ØØ( /
=
ØØ0 1
true
ØØ2 6
,
ØØ6 7
Message
ØØ8 ?
=
ØØ@ A
$str
ØØB Q
}
ØØR S
;
ØØS T
}
±± 
catch
≤≤ 
(
≤≤ 
	Exception
≤≤ 
ex
≤≤ 
)
≤≤  
{
≥≥ 
return
¥¥ 
new
¥¥ 

DbResponse
¥¥ %
{
¥¥& '
Success
¥¥( /
=
¥¥0 1
false
¥¥2 7
,
¥¥7 8
Message
¥¥9 @
=
¥¥A B
ex
¥¥C E
.
¥¥E F
Message
¥¥F M
}
¥¥N O
;
¥¥O P
}
∂∂ 
}
∑∑ 	
public
ππ 

DbResponse
ππ 
AddOrderProduct
ππ )
(
ππ) *
OrderProductDTO
ππ* 9
orderProduct
ππ: F
)
ππF G
{
∫∫ 	
try
ªª 
{
ºº 
var
ΩΩ 
order
ΩΩ 
=
ΩΩ 

_dbContext
ΩΩ &
.
ΩΩ& '
pedidos
ΩΩ' .
.
ΩΩ. /
Find
ΩΩ/ 3
(
ΩΩ3 4
orderProduct
ΩΩ4 @
.
ΩΩ@ A
	id_Pedido
ΩΩA J
)
ΩΩJ K
;
ΩΩK L
if
ææ 
(
ææ 
order
ææ 
!=
ææ 
null
ææ !
)
ææ! "
{
øø 

_dbContext
¿¿ 
.
¿¿ 
pedidos_Platos
¿¿ -
.
¿¿- .
Add
¿¿. 1
(
¿¿1 2
orderProduct
¿¿2 >
)
¿¿> ?
;
¿¿? @

_dbContext
¡¡ 
.
¡¡ 
SaveChanges
¡¡ *
(
¡¡* +
)
¡¡+ ,
;
¡¡, -
return
¬¬ 
new
¬¬ 

DbResponse
¬¬ )
{
¬¬* +
Success
¬¬, 3
=
¬¬4 5
true
¬¬6 :
,
¬¬: ;
Message
¬¬< C
=
¬¬D E
$str
¬¬F b
}
¬¬c d
;
¬¬d e
}
√√ 
else
ƒƒ 
{
≈≈ 
return
∆∆ 
new
∆∆ 

DbResponse
∆∆ )
{
∆∆* +
Success
∆∆, 3
=
∆∆4 5
false
∆∆6 ;
,
∆∆; <
Message
∆∆= D
=
∆∆E F
$str
∆∆G f
}
∆∆g h
;
∆∆h i
}
«« 
}
»» 
catch
…… 
(
…… 
	Exception
…… 
ex
…… 
)
……  
{
   
return
ÀÀ 
new
ÀÀ 

DbResponse
ÀÀ %
{
ÀÀ& '
Success
ÀÀ( /
=
ÀÀ0 1
false
ÀÀ2 7
,
ÀÀ7 8
Message
ÀÀ9 @
=
ÀÀA B
ex
ÀÀC E
.
ÀÀE F
Message
ÀÀF M
}
ÀÀN O
;
ÀÀO P
}
ÕÕ 
}
ŒŒ 	
public
–– 
List
–– 
<
–– 
OrderDTO
–– 
>
–– !
GetOrdersWithFilter
–– 1
(
––1 2
int
––2 5
id
––6 8
,
––8 9
string
––: @
filter
––A G
,
––G H
int
––I L

pageNumber
––M W
,
––W X
int
––Y \
pageSize
––] e
)
––e f
{
—— 	
try
““ 
{
”” 
var
‘‘ 
Orders
‘‘ 
=
‘‘ 

_dbContext
‘‘ '
.
‘‘' (
pedidos
‘‘( /
.
‘‘/ 0
Where
‘‘0 5
(
‘‘5 6
p
‘‘6 7
=>
‘‘8 :
p
‘‘; <
.
‘‘< =
id_Restaurante
‘‘= K
==
‘‘L N
id
‘‘O Q
&&
‘‘R T
p
‘‘U V
.
‘‘V W
Estado
‘‘W ]
==
‘‘] _
filter
‘‘_ e
)
‘‘e f
.
‘‘f g
ToList
‘‘g m
(
‘‘m n
)
‘‘n o
;
‘‘o p
int
’’ 
total
’’ 
=
’’ 
Orders
’’ "
.
’’" #
Count
’’# (
(
’’( )
)
’’) *
;
’’* +
int
÷÷ 
pages
÷÷ 
=
÷÷ 
(
÷÷ 
int
÷÷  
)
÷÷  !
Math
÷÷! %
.
÷÷% &
Ceiling
÷÷& -
(
÷÷- .
(
÷÷. /
double
÷÷/ 5
)
÷÷5 6
total
÷÷6 ;
/
÷÷< =
pageSize
÷÷> F
)
÷÷F G
;
÷÷G H
var
ÿÿ 
	resultado
ÿÿ 
=
ÿÿ 
Orders
ÿÿ  &
.
ŸŸ 
AsEnumerable
ŸŸ !
(
ŸŸ! "
)
ŸŸ" #
.
⁄⁄ 
Skip
⁄⁄ 
(
⁄⁄ 
(
⁄⁄ 

pageNumber
⁄⁄ %
-
⁄⁄& '
$num
⁄⁄( )
)
⁄⁄) *
*
⁄⁄+ ,
pageSize
⁄⁄- 5
)
⁄⁄5 6
.
€€ 
Take
€€ 
(
€€ 
pageSize
€€ "
)
€€" #
.
‹‹ 
ToList
‹‹ 
(
‹‹ 
)
‹‹ 
;
‹‹ 
return
›› 
	resultado
››  
;
››  !
}
ﬁﬁ 
catch
ﬂﬂ 
(
ﬂﬂ 
	Exception
ﬂﬂ 
ex
ﬂﬂ 
)
ﬂﬂ  
{
‡‡ 
return
·· 
null
·· 
;
·· 
}
‚‚ 
}
„„ 	
}
‰‰ 
}ÂÂ 